
0 VALUE ID_SHIFT@
0 VALUE ID_ALT@
0 VALUE ID_CTR@

: EKEY>GCHAR ( u -- u false | char true ) \ 93 FACILITY EXT
  DUP  0x11D0000 = IF -1 TO ID_CTR@   FALSE BREAK
  DUP  0x01D0000 = IF  0 TO ID_CTR@   FALSE BREAK
  DUP  0x1380000 = IF -1 TO ID_ALT@   FALSE BREAK
  DUP  0x0380000 = IF  0 TO ID_ALT@   FALSE BREAK
  DUP  0x12A0000 = IF -1 TO ID_SHIFT@ FALSE BREAK
  DUP  0x02A0000 = IF  0 TO ID_SHIFT@ FALSE BREAK
  DUP  0x1360000 = IF -1 TO ID_SHIFT@ FALSE BREAK
  DUP  0x0360000 = IF  0 TO ID_SHIFT@ FALSE BREAK
  DUP  0xFF000000 AND  0=   IF FALSE    BREAK
  DUP  0x000000FF AND  DUP IF
    ID_ALT@
   IF   DROP 0x10 RSHIFT \ 0x30 +
   ELSE NIP
   THEN TRUE BREAK DROP
  DUP  0x00FF0000 AND  DUP IF NIP 0x10 RSHIFT 0x100 OR
\ ID_ALT@   IF 0x57 XOR THEN
 ID_ALT@   IF 0xD0 XOR THEN
 ID_CTR@   IF 0xC0 XOR THEN
  TRUE  BREAK
 DROP
  FALSE
;

VARIABLE PENDING-CHAR

: GKEY? ( -- flag ) \ 94 FACILITY
  PENDING-CHAR @ 0 > IF TRUE BREAK
  BEGIN
    EKEY?
  WHILE
    EKEY  EKEY>GCHAR
    IF PENDING-CHAR !
       TRUE EXIT
    THEN
    DROP
  REPEAT FALSE
;

: GKEY ( -- char ) \ 94
  PENDING-CHAR @ 0 >
  IF PENDING-CHAR @ -1 PENDING-CHAR ! BREAK
  BEGIN
    EKEY  EKEY>GCHAR 0=
  WHILE
    DROP
  REPEAT
;
